

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Financeiro - Tekinformática</title>
    <link rel="icon" href="https://i.imgur.com/oYXN4GO.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f4f8;
        }
        
        .dashboard-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        
        .dashboard-card:hover {
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        .btn-primary {
            background-color: #3b82f6;
            color: white;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background-color: #2563eb;
        }
        
        .btn-secondary {
            background-color: #64748b;
            color: white;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background-color: #475569;
        }
        
        .btn-success {
            background-color: #10b981;
            color: white;
            transition: all 0.3s ease;
        }
        
        .btn-success:hover {
            background-color: #059669;
        }
        
        .btn-danger {
            background-color: #ef4444;
            color: white;
            transition: all 0.3s ease;
        }
        
        .btn-danger:hover {
            background-color: #dc2626;
        }
        
        .btn-warning {
            background-color: #f59e0b;
            color: white;
            transition: all 0.3s ease;
        }
        
        .btn-warning:hover {
            background-color: #d97706;
        }
        
        .header-gradient {
            background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        
        .table-header {
            background-color: #f1f5f9;
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .logo-text {
            background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Hide file input visually but keep it accessible */
        .file-input {
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Header -->
    <header class="header-gradient text-white p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                    <line x1="8" y1="21" x2="16" y2="21"></line>
                    <line x1="12" y1="17" x2="12" y2="21"></line>
                </svg>
                <div>
                    <h1 class="text-2xl font-bold">Tekinformática</h1>
                    <p class="text-sm opacity-80">Dashboard Financeiro</p>
                </div>
            </div>
            <div class="flex flex-wrap gap-2">
                <button id="importCSVBtn" class="btn-secondary px-4 py-2 rounded-lg flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                    </svg>
                    Importar CSV Remoto
                </button>
                
                <label for="fileInput" class="btn-warning px-4 py-2 rounded-lg flex items-center cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a3 3 0 00-3 3v4a5 5 0 0010 0V7a1 1 0 112 0v4a7 7 0 11-14 0V7a5 5 0 0110 0v4a3 3 0 11-6 0V7a1 1 0 012 0v4a1 1 0 102 0V7a3 3 0 00-3-3z" clip-rule="evenodd" />
                    </svg>
                    Importar Arquivo
                </label>
                <input type="file" id="fileInput" class="file-input" accept=".csv">
                
                <button id="exportBtn" class="btn-primary px-4 py-2 rounded-lg flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM13.707 6.707a1 1 0 010-1.414l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 5.414V13a1 1 0 102 0V5.414l1.293 1.293a1 1 0 001.414 0z" clip-rule="evenodd" />
                    </svg>
                    Exportar
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto py-8 px-4">
        <!-- Asset Name Input -->
        <div class="dashboard-card p-6 mb-8 animate-fade-in">
            <div class="flex flex-col md:flex-row md:items-center justify-between mb-6">
                <h2 class="text-xl font-semibold text-gray-800">Análise de Custos e Lucro</h2>
                <div class="mt-4 md:mt-0">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome do Ativo:</label>
                    <input type="text" id="assetName" class="border border-gray-300 rounded-lg px-4 py-2 w-full md:w-64" placeholder="Digite o nome do ativo">
                </div>
            </div>
            
            <!-- Data Table -->
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead class="table-header">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Item</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Custo (R$)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Lucro (%)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Valor Total (R$)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="investmentTable">
                        <!-- Table rows will be added dynamically -->
                    </tbody>
                </table>
            </div>
            
            <div class="mt-6 flex justify-end">
                <button id="addItemBtn" class="btn-success px-4 py-2 rounded-lg flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    Adicionar Item
                </button>
            </div>
        </div>
        
        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="dashboard-card p-6 animate-fade-in">
                <h3 class="text-lg font-medium text-gray-700 mb-2">Custo Total</h3>
                <p id="totalCost" class="text-3xl font-bold text-gray-900">R$ 0,00</p>
                <p class="text-sm text-gray-500 mt-2">Soma de todos os custos</p>
            </div>
            
            <div class="dashboard-card p-6 animate-fade-in">
                <h3 class="text-lg font-medium text-gray-700 mb-2">Valor Total com Lucro</h3>
                <p id="totalWithProfit" class="text-3xl font-bold text-green-600">R$ 0,00</p>
                <p class="text-sm text-gray-500 mt-2">Soma de custos + lucro</p>
            </div>
            
            <div class="dashboard-card p-6 animate-fade-in">
                <h3 class="text-lg font-medium text-gray-700 mb-2">Lucro Total</h3>
                <p id="totalProfit" class="text-3xl font-bold text-blue-600">R$ 0,00</p>
                <p class="text-sm text-gray-500 mt-2">Diferença entre valor total e custo</p>
            </div>
        </div>
        
        <!-- Charts and Analysis -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="dashboard-card p-6 animate-fade-in">
                <h3 class="text-lg font-medium text-gray-700 mb-4">Distribuição de Valores Totais</h3>
                <div class="h-64">
                    <canvas id="costChart"></canvas>
                </div>
            </div>
            
            <div class="dashboard-card p-6 animate-fade-in">
                <h3 class="text-lg font-medium text-gray-700 mb-4">Análise Financeira</h3>
                <div id="financialAnalysis" class="text-gray-700">
                    <p class="mb-2">Aguardando dados para análise...</p>
                </div>
            </div>
        </div>
        
        <!-- Installment Plans -->
        <div class="dashboard-card p-6 mb-8 animate-fade-in">
            <h3 class="text-lg font-medium text-gray-700 mb-4">Simulação de Parcelamento</h3>
            <div class="mb-4 flex flex-col md:flex-row md:items-center gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Valor Total:</label>
                    <input type="text" id="installmentAmount" class="border border-gray-300 rounded-lg px-4 py-2 w-full" placeholder="0,00">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Taxa de Juros (%):</label>
                    <input type="number" id="interestRate" class="border border-gray-300 rounded-lg px-4 py-2 w-full" value="7" step="0.1">
                </div>
                <div class="mt-4 md:mt-6">
                    <button id="calculateInstallments" class="btn-primary px-4 py-2 rounded-lg">Calcular Parcelas</button>
                </div>
            </div>
            
            <div class="overflow-x-auto mt-4">
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead class="table-header">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Parcelas</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Valor da Parcela (R$)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Juros Total (R$)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Valor Total (R$)</th>
                        </tr>
                    </thead>
                    <tbody id="installmentTable">
                        <!-- Installment rows will be added dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center space-x-2 mb-4 md:mb-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                        <line x1="8" y1="21" x2="16" y2="21"></line>
                        <line x1="12" y1="17" x2="12" y2="21"></line>
                    </svg>
                    <div>
                        <h2 class="text-xl font-bold">Tekinformática</h2>
                        <p class="text-sm opacity-80">Dashboard Financeiro</p>
                    </div>
                </div>
                <div class="text-center md:text-right">
                    <p class="text-sm opacity-80">© 2011 Tekinformática - Todos os direitos reservados</p>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Global variables
        let investments = [];
        let chart = null;
        
        // Format number to Brazilian currency format
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 2
            }).format(value);
        }
        
        // Parse Brazilian currency format to number
        function parseCurrency(value) {
            if (typeof value === 'number') return value;
            if (!value) return 0;
            
            // Remove currency symbol, dots and replace comma with dot
            return parseFloat(value.replace(/[^\d,.-]/g, '').replace('.', '').replace(',', '.')) || 0;
        }
        
        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners
            document.getElementById('addItemBtn').addEventListener('click', addNewItem);
            document.getElementById('importCSVBtn').addEventListener('click', importCSVData);
            document.getElementById('exportBtn').addEventListener('click', exportData);
            document.getElementById('calculateInstallments').addEventListener('click', calculateInstallments);
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            
            // Format installment amount input as currency
            const installmentAmountInput = document.getElementById('installmentAmount');
            installmentAmountInput.addEventListener('blur', function() {
                this.value = formatCurrency(parseCurrency(this.value));
            });
            
            // Initialize with empty data
            renderTable();
            initializeChart();
        });
        
        // Initialize empty chart
        function initializeChart() {
            const ctx = document.getElementById('costChart').getContext('2d');
            
            chart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Distribuição de Valores Totais',
                        data: [],
                        backgroundColor: [],
                        borderColor: [],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0) || 0;
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${formatCurrency(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Handle file upload
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                showNotification('Nenhum arquivo selecionado.', 'error');
                return;
            }
            
            // Show loading notification
            showNotification('Carregando arquivo...', 'info');
            
            // Use FileReader to read the file content
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const csvContent = e.target.result;
                    
                    Papa.parse(csvContent, {
                        header: true,
                        skipEmptyLines: true,
                        complete: function(results) {
                            if (results.data && results.data.length > 0) {
                                processCSVData(results.data);
                                showNotification('Arquivo importado com sucesso!', 'success');
                            } else {
                                showNotification('Arquivo vazio ou formato inválido.', 'error');
                            }
                        },
                        error: function(error) {
                            console.error("Error parsing file:", error);
                            showNotification('Erro ao processar o arquivo CSV.', 'error');
                        }
                    });
                } catch (error) {
                    console.error("Error reading file:", error);
                    showNotification('Erro ao ler o arquivo.', 'error');
                }
            };
            
            reader.onerror = function() {
                showNotification('Erro ao ler o arquivo.', 'error');
            };
            
            // Read the file as text
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }
        
        // Process CSV data
        function processCSVData(data) {
            investments = [];
            
            // Take up to 6 items from the CSV
            const itemCount = Math.min(data.length, 6);
            
            for (let i = 0; i < itemCount; i++) {
                const item = data[i];
                
                // Try to get values from different possible column names
                const name = item.Item || item.Nome || item.name || item.item || `Item ${i+1}`;
                let cost = 0;
                let profitPercent = 0;
                
                // Try to parse cost from different possible column names
                if (item.Custo !== undefined) cost = parseCurrency(item.Custo);
                else if (item.Cost !== undefined) cost = parseCurrency(item.Cost);
                else if (item.custo !== undefined) cost = parseCurrency(item.custo);
                else if (item.cost !== undefined) cost = parseCurrency(item.cost);
                else if (item.Valor !== undefined) cost = parseCurrency(item.Valor);
                else if (item.valor !== undefined) cost = parseCurrency(item.valor);
                
                // Try to parse profit percentage from different possible column names
                if (item.LucroPercent !== undefined) profitPercent = parseFloat(item.LucroPercent);
                else if (item.Lucro !== undefined) profitPercent = parseFloat(item.Lucro);
                else if (item.lucro !== undefined) profitPercent = parseFloat(item.lucro);
                else if (item.ProfitPercent !== undefined) profitPercent = parseFloat(item.ProfitPercent);
                else if (item.Profit !== undefined) profitPercent = parseFloat(item.Profit);
                else if (item.profit !== undefined) profitPercent = parseFloat(item.profit);
                
                investments.push({
                    name: name,
                    cost: cost || 0,
                    profitPercent: profitPercent || 0
                });
            }
            
            // Render the table
            renderTable();
            updateSummary();
            updateChart();
        }
        
        // Load CSV data from remote URL
        function importCSVData() {
            const csvUrl = "https://tekinf2025.github.io/investimentos/investimentos-csv.csv";
            
            // Show loading notification
            showNotification('Carregando dados do CSV remoto...', 'info');
            
            Papa.parse(csvUrl, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.data && results.data.length > 0) {
                        processCSVData(results.data);
                    } else {
                        showNotification('Erro ao carregar dados. Formato inválido ou vazio.', 'error');
                    }
                },
                error: function(error) {
                    console.error("Error loading CSV:", error);
                    showNotification('Erro ao carregar o arquivo CSV remoto.', 'error');
                }
            });
        }
        
        // Render the investment table
        function renderTable() {
            const tableBody = document.getElementById('investmentTable');
            tableBody.innerHTML = '';
            
            if (investments.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                        Nenhum item encontrado. Importe dados ou adicione itens manualmente.
                    </td>
                `;
                tableBody.appendChild(emptyRow);
                return;
            }
            
            investments.forEach((item, index) => {
                const totalValue = item.cost * (1 + item.profitPercent / 100);
                
                const row = document.createElement('tr');
                row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="text" value="${item.name}" class="border-0 bg-transparent w-full focus:ring-2 focus:ring-blue-500 rounded" 
                            onchange="updateItemName(${index}, this.value)">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="text" value="${formatCurrency(item.cost)}" class="border-0 bg-transparent w-full focus:ring-2 focus:ring-blue-500 rounded" 
                            onchange="updateItemCost(${index}, this.value)" onblur="formatInputCurrency(this, ${index})">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="number" value="${item.profitPercent}" class="border-0 bg-transparent w-full focus:ring-2 focus:ring-blue-500 rounded" 
                            onchange="updateItemProfit(${index}, this.value)" step="0.01">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">
                        ${formatCurrency(totalValue)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">
                        <button onclick="removeItem(${index})" class="text-red-600 hover:text-red-900">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // Format input as currency
        function formatInputCurrency(input, index) {
            const value = parseCurrency(input.value);
            input.value = formatCurrency(value);
            investments[index].cost = value;
            updateSummary();
            updateChart();
        }
        
        // Update item name
        function updateItemName(index, value) {
            investments[index].name = value;
            updateSummary();
            updateChart();
        }
        
        // Update item cost
        function updateItemCost(index, value) {
            investments[index].cost = parseCurrency(value);
            updateSummary();
            updateChart();
        }
        
        // Update item profit percentage
        function updateItemProfit(index, value) {
            investments[index].profitPercent = parseFloat(value) || 0;
            renderTable();
            updateSummary();
            updateChart();
        }
        
        // Remove an item
        function removeItem(index) {
            investments.splice(index, 1);
            renderTable();
            updateSummary();
            updateChart();
        }
        
        // Add a new item
        function addNewItem() {
            investments.push({
                name: `Item ${investments.length + 1}`,
                cost: 0,
                profitPercent: 0
            });
            
            renderTable();
            updateSummary();
            updateChart();
        }
        
        // Update summary calculations
        function updateSummary() {
            // Calculate totals
            const totalCost = investments.reduce((sum, item) => sum + item.cost, 0);
            const totalWithProfit = investments.reduce((sum, item) => sum + (item.cost * (1 + item.profitPercent / 100)), 0);
            const totalProfit = totalWithProfit - totalCost;
            
            // Update summary display
            document.getElementById('totalCost').textContent = formatCurrency(totalCost);
            document.getElementById('totalWithProfit').textContent = formatCurrency(totalWithProfit);
            document.getElementById('totalProfit').textContent = formatCurrency(totalProfit);
            
            // Update financial analysis
            updateFinancialAnalysis(totalCost, totalWithProfit, totalProfit);
        }
        
        // Update financial analysis text
        function updateFinancialAnalysis(totalCost, totalWithProfit, totalProfit) {
            const analysisElement = document.getElementById('financialAnalysis');
            const profitMargin = totalCost > 0 ? (totalProfit / totalCost) * 100 : 0;
            
            let analysisText = '';
            
            if (totalCost === 0) {
                analysisText = '<p>Adicione itens para gerar uma análise financeira.</p>';
            } else {
                analysisText = `
                    <p class="mb-2"><span class="font-medium">Custo Total:</span> ${formatCurrency(totalCost)}</p>
                    <p class="mb-2"><span class="font-medium">Receita Total:</span> ${formatCurrency(totalWithProfit)}</p>
                    <p class="mb-2"><span class="font-medium">Lucro Total:</span> ${formatCurrency(totalProfit)}</p>
                    <p class="mb-2"><span class="font-medium">Margem de Lucro:</span> ${profitMargin.toFixed(2)}%</p>
                `;
                
                if (profitMargin < 10) {
                    analysisText += '<p class="text-red-600 font-medium mt-4">Alerta: Margem de lucro abaixo de 10%. Considere revisar os custos ou aumentar as margens de lucro.</p>';
                } else if (profitMargin >= 10 && profitMargin < 20) {
                    analysisText += '<p class="text-yellow-600 font-medium mt-4">Margem de lucro aceitável, mas há espaço para melhorias.</p>';
                } else {
                    analysisText += '<p class="text-green-600 font-medium mt-4">Excelente margem de lucro! O negócio está performando bem.</p>';
                }
            }
            
            analysisElement.innerHTML = analysisText;
        }
        
        // Update chart visualization
        function updateChart() {
            // Prepare data for chart - now using total values instead of just costs
            const labels = investments.map(item => item.name);
            const totalValues = investments.map(item => item.cost * (1 + item.profitPercent / 100));
            
            // Define vibrant colors for the chart
            const backgroundColors = [
                'rgba(255, 99, 132, 0.8)',    // Vibrant pink
                'rgba(54, 162, 235, 0.8)',    // Bright blue
                'rgba(255, 206, 86, 0.8)',    // Bright yellow
                'rgba(75, 192, 192, 0.8)',    // Teal
                'rgba(153, 102, 255, 0.8)',   // Purple
                'rgba(255, 159, 64, 0.8)',    // Orange
                'rgba(46, 204, 113, 0.8)',    // Green
                'rgba(142, 68, 173, 0.8)',    // Deep purple
                'rgba(241, 196, 15, 0.8)',    // Gold
                'rgba(231, 76, 60, 0.8)'      // Red
            ];
            
            const borderColors = [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)',
                'rgba(46, 204, 113, 1)',
                'rgba(142, 68, 173, 1)',
                'rgba(241, 196, 15, 1)',
                'rgba(231, 76, 60, 1)'
            ];
            
            // Update chart data
            chart.data.labels = labels;
            chart.data.datasets[0].data = totalValues;
            chart.data.datasets[0].backgroundColor = backgroundColors.slice(0, labels.length);
            chart.data.datasets[0].borderColor = borderColors.slice(0, labels.length);
            
            // Update chart
            chart.update();
        }
        
        // Calculate installment plans
        function calculateInstallments() {
            const amount = parseCurrency(document.getElementById('installmentAmount').value) || 0;
            const interestRate = parseFloat(document.getElementById('interestRate').value) || 4;
            const tableBody = document.getElementById('installmentTable');
            
            tableBody.innerHTML = '';
            
            if (amount <= 0) {
                showNotification('Por favor, insira um valor válido para calcular as parcelas.', 'error');
                return;
            }
            
            // Calculate installments for 1 to 12 months
            for (let i = 1; i <= 12; i++) {
                // Calculate compound interest
                const totalAmount = amount * Math.pow(1 + (interestRate / 100), i);
                const installmentAmount = totalAmount / i;
                const totalInterest = totalAmount - amount;
                
                const row = document.createElement('tr');
                row.className = i % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${i}x</td>
                    <td class="px-6 py-4 whitespace-nowrap">${formatCurrency(installmentAmount)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${formatCurrency(totalInterest)}</td>
                    <td class="px-6 py-4 whitespace-nowrap font-medium">${formatCurrency(totalAmount)}</td>
                `;
                
                tableBody.appendChild(row);
            }
        }
        
        // Export data function
        function exportData() {
            if (investments.length === 0) {
                showNotification('Não há dados para exportar.', 'error');
                return;
            }
            
            try {
                // Create CSV content
                let csvContent = "Item,Custo,LucroPercent\n";
                
                investments.forEach(item => {
                    // Format values properly for CSV
                    const name = item.name.includes(',') ? `"${item.name}"` : item.name;
                    const cost = item.cost.toString().replace('.', ',');
                    const profit = item.profitPercent.toString().replace('.', ',');
                    
                    csvContent += `${name},${cost},${profit}\n`;
                });
                
                // Create download link using Blob
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                
                // Create a temporary anchor element
                const link = document.createElement('a');
                
                // Create a URL for the blob
                const url = window.URL.createObjectURL(blob);
                
                // Set link properties
                link.href = url;
                link.download = 'tekinformatica_investimentos.csv';
                link.style.display = 'none';
                
                // Add to document, click and remove
                document.body.appendChild(link);
                link.click();
                
                // Clean up
                setTimeout(() => {
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                }, 100);
                
                // Show success notification
                showNotification('Dados exportados com sucesso!', 'success');
            } catch (error) {
                console.error("Error exporting data:", error);
                showNotification('Erro ao exportar os dados.', 'error');
            }
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            
            // Set class based on notification type
            let bgColor;
            switch(type) {
                case 'success':
                    bgColor = 'bg-green-500';
                    break;
                case 'error':
                    bgColor = 'bg-red-500';
                    break;
                default:
                    bgColor = 'bg-blue-500';
            }
            
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in ${bgColor} text-white`;
            notification.textContent = message;
            
            // Add to document
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s ease';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 500);
            }, 3000);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'94863e36d638c802',t:'MTc0ODY5MjExNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
